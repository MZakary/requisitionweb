<div class="card requisitonJSON">
  <h1 tabindex="-1" #pageTitle>Réquisition {{ requisitionType }}</h1>

  <div class="p-field">
    <label for="json-upload">Charger un fichier JSON:</label>
    <input type="file" id="json-upload" (change)="onFileSelected($event)" accept=".json" />
  </div>

  <hr />

  <form [formGroup]="form">
    <ng-container *ngFor="let field of formFields">
      <!-- Champs généraux -->
      <h2 *ngIf="field.type === 'header2'" class="form-section-header">{{ field.label }}</h2>
      <h3 *ngIf="field.type === 'header3'" class="form-section-header">{{ field.label }}</h3>

      <p-floatLabel *ngIf="field.type === 'text' || field.type === 'email' || field.type === 'number'" variant="on">
        <input
          pInputText
          [type]="field.type"
          [id]="field.key"
          [formControlName]="field.key"
          style="width: 30%"
        />
        <label [for]="field.key">{{ field.label }}</label>
      </p-floatLabel>

      <div *ngIf="field.type === 'tableHeure'" [formGroupName]="field.key" class="table-heure-wrapper">
        <h4>{{ field.label }}</h4>

        <ul style="list-style: none; padding-left: 0; display: flex; justify-content: center; align-items: center;">
          <li *ngFor="let col of field.columns" class="table-heure-col">
            <!-- <label [for]="field.key + '-' + col.key" class="p-sr-only">
              {{ col.label }}
            </label> -->
            <p-floatLabel>
              <input
                pInputText
                [id]="field.key + '-' + col.key"
                [type]="col.type || 'text'"
                [formControlName]="col.key"
              />
              <label [for]="field.key + '-' + col.key">{{ col.label }}</label>
            </p-floatLabel>
          </li>

          <li>
            <p-floatLabel>
              <input
                pInputText
                id="total-heures"
                [value]="totalHeures"
                readonly
                style="font-weight: bold;"
                aria-live="polite"
                aria-label="Total des heures"
              />
              <label for="total-heures">Total des heures</label>
            </p-floatLabel>
          </li>
        </ul>
      </div>

      <p-floatLabel *ngIf="field.type === 'date'" variant="on">
        <p-calendar [inputId]="field.key" [formControlName]="field.key" dateFormat="yy-mm-dd"></p-calendar>
        <label [for]="field.key">{{ field.label }}</label>
      </p-floatLabel>

      <div *ngIf="field.type === 'checkbox'" class="p-field-checkbox">
        <p-checkbox binary="true" [inputId]="field.key" [formControlName]="field.key"></p-checkbox>
        <label [for]="field.key">{{ field.label }}</label>
      </div>

      <div *ngIf="field.type === 'select'" class="p-field">
        <label [for]="field.key">{{ field.label }}</label>
        <p-dropdown
          [options]="field.options"
          optionLabel="label"
          optionValue="value"
          [inputId]="field.key"
          [formControlName]="field.key"
          [style]="{ width: '30%' }"
        ></p-dropdown>
      </div>
    </ng-container>

    <!-- ------------------------------------------------------ PHASES ------------------------------------------------------ -->
    <hr *ngIf="needsPhase"/>
    <h2 *ngIf="needsPhase">Phases de production</h2>

    <div formArrayName="phases" *ngIf="needsPhase">
      <div
        *ngFor="let phase of phases.controls; let i = index"
        [formGroupName]="i"
        class="phase-section"
      >
        <h3>Phase {{ i + 1 }}</h3>

        <!-- List of checkboxes for selectedTypes -->
        <div class="production-types">
          <div *ngFor="let type of productionTypes" style="display: flex; align-items: center; gap: 10px;">
            <p-checkbox
              [inputId]="'phase-' + i + '-' + type.value"
              [binary]="false"
              [value]="type.value"
              formControlName="selectedTypes"
            ></p-checkbox>
            <label [for]="'phase-' + i + '-' + type.value">{{ type.label }}</label>
          </div>
        </div>


        <!-- eText Fields -->
        <ng-template #renderFields let-type="type" let-fields="fields" let-i="index">
          <div *ngIf="getPhaseGroup(phase).get('selectedTypes')?.value.includes(type)">
            <hr />
            <h3>{{ type | titlecase }}</h3> 

            <div [formGroup]="getNestedGroup(phase, type)">
              <div *ngFor="let field of fields" style="margin-bottom: 1rem;">
                <ng-container [ngSwitch]="field.type">

                  <!-- Horizontal Seperator -->
                  <hr *ngSwitchCase="'hr'" style="width: 30%" />
                  <!-- Header 4 -->
                  <h4 *ngSwitchCase="'header4'">{{ field.label }}</h4>

                  <!-- Text input -->
                  <p-floatLabel *ngSwitchCase="'text'">
                    <input
                      pInputText
                      [id]="field.key"
                      [formControlName]="field.key"
                      style="width: 30%"
                    />
                    <label [for]="field.key">{{ field.label }}</label>
                  </p-floatLabel>

                  <!-- Checkbox -->
                  <div *ngSwitchCase="'checkbox'" style="display: flex; align-items: center;">
                    <p-checkbox
                      [inputId]="field.key"
                      [formControlName]="field.key"
                      binary="true"
                    ></p-checkbox>
                    <label [for]="field.key" style="margin-left: 0.5rem;">{{ field.label }}</label>
                  </div>

                  <!-- Add this case to your ngSwitch in the template -->
                  <div *ngSwitchCase="'checkbox-list'" class="checkbox-list">
                    <label>{{ field.label }}</label>
                    <div class="checkbox-options" [formGroupName]="field.key">
                      <div *ngFor="let option of field.options" class="p-field-checkbox">
                        <p-checkbox
                          [inputId]="field.key + '-' + option.value"
                          formControlName="{{option.value}}"
                          [binary]="true"
                        ></p-checkbox>
                        <label [for]="field.key + '-' + option.value">{{ option.label }}</label>
                      </div>
                    </div>
                  </div>


                  <!-- Select dropdown -->
                  <ng-container *ngSwitchCase="'select'">
                    <label [for]="field.key" style="display:block; margin-bottom: 0.25rem;">
                      {{ field.label }}
                    </label>
                    <p-dropdown
                      [options]="field.options"
                      [formControlName]="field.key"
                      [filter]="true" 
                      [showClear]="true"
                      placeholder="Select {{ field.label }}"
                      [style]="{ width: '30%' }"
                      [inputId]="field.key"
                    ></p-dropdown>
                  </ng-container>

                  <!-- Default fallback -->
                  <div *ngSwitchDefault>
                    Unknown field type: {{ field.type }}
                  </div>

                </ng-container>

              </div>
            </div>

          </div>
        </ng-template>

        <!-- Then call it twice for eText and Braille -->
        <ng-container
          *ngTemplateOutlet="renderFields; context: { type: 'etext', fields: eTextFormFields }"
        ></ng-container>

        <ng-container
          *ngTemplateOutlet="renderFields; context: { type: 'braille', fields: brailleFormFields }"
        ></ng-container>

        <!-- Audio Fields -->

        <!-- ✅ Move delete button here -->
        <p-button icon="pi pi-trash" label="Supprimer la phase" (click)="deletePhase(i)" />

        <hr />

      </div>
    </div>

    <p-button *ngIf="needsPhase" label="Ajouter une phase" icon="pi pi-plus" (onClick)="addPhase()"></p-button>
    
  </form>

  <hr />
  <p-button label="Download JSON" (onClick)="downloadJson()"></p-button>
</div>
